_srcname=grub
pkgname=${_srcname}-legacy
pkgver=0.97
pkgrel=1
pkgdesc="C Standard Library"
arch=('i686' 'x86_64')
url="http://gnu.org/software/grub/"
license=('GPL')
groups=('base')
backup=(boot/grub/menu.lst)
source=(http://alpha.gnu.org/gnu/${_srcname}/${_srcname}-${pkgver}.tar.gz
        menu.lst
        install-grub
        040_all_grub-0.96-nxstack.patch
        05-grub-0.97-initrdaddr.diff
        i2o.patch
        special-devices.patch
        more-raid.patch
        intelmac.patch
        grub-inode-size.patch
        ext4.patch
        grub-0.97-ldflags-objcopy-remove-build-id.patch
        automake-pkglib.patch)

prepare() {
  cd "${srcdir}/${_srcname}-${pkgver}"

  # optimizations break the build -- disable them
  # adding special devices to grub, patches are from fedora
  patch -Np1 -i ../special-devices.patch
  toybox patch -p1 -i ../i2o.patch
#  patch -Np1 -i ../more-raid.patch
  toybox patch -l -p1 -i ../intelmac.patch
  # Add support for bigger inode size to e2fs_stage1_5
  patch -Np1 -i ../grub-inode-size.patch
  # Add ext4 support
  # http://www.mail-archive.com/bug-grub@gnu.org/msg11458.html
  toybox patch -l -p1 -i ../ext4.patch
  # binutils fix
#  patch -Np1 -i ../grub-0.97-ldflags-objcopy-remove-build-id.patch
  # "pkglib" is a reserved keyword in automake fix
  patch -Np1 -i ../automake-pkglib.patch

#  sed -e'/^AC_PROG_CC/ a\AM_PROG_CC_C_O\ ' -i "${srcdir}/${_srcname}-${pkgver}/configure.ac"
#  sed -e'/^AC_PROG_CC/ a\AM_PROG_AS\ ' -i "${srcdir}/${_srcname}-${pkgver}/configure.ac"

  ## recreate ./configure script with the required changes in LDFLAGS and objcopy
#  aclocal
#  autoconf
#  autoreconf -i
#  automake
}

build() {
  cd "${srcdir}/${_srcname}-${pkgver}"

  # musl does have large file support
  sed -i.bak -e 's/!defined(__GLIBC__) ||/defined(__GLIBC__) \&\&/g' lib/device.c grub/asmstub.c

  if [ "$CARCH" = "x86_64" ]; then
    # patch from gentoo for fixing a segfault
    toybox patch -p1 -i ../040_all_grub-0.96-nxstack.patch
    # patch from frugalware to make it boot when more than 2GB ram installed
    patch -Np1 -i ../05-grub-0.97-initrdaddr.diff
    CC="gcc -m32" CFLAGS="-static -fno-strict-aliasing" \
    ./configure --prefix= --bindir=/bin --sbindir=/bin \
      --mandir=/share/man --infodir=/share/info
  else
    CFLAGS="-fno-strict-aliasing" \
    ./configure --prefix= --bindir=/bin --sbindir=/bin \
      --mandir=/share/man --infodir=/share/info
  fi

  unset CFLAGS
  make
}

package() {
  cd "${srcdir}/${_srcname}-${pkgver}"

  make DESTDIR="${pkgdir}" install
  install -Dm644 "${srcdir}/menu.lst" "${pkgdir}/boot/grub/menu.lst"
#  install -Dm755 "${srcdir}/install-grub" "${pkgdir}/bin/install-grub"
}
